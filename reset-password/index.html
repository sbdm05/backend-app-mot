<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ionic library -->
<script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
  <title>Reinitialiser le mot de passe</title>
</head>
<body>
  <ion-content>
    <ion-card>
      <ion-card-header>
        <ion-card-title>Card Title</ion-card-title>
        <ion-card-subtitle>Card Subtitle</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        Here's a small text description for the card content. Nothing more, nothing less.
      </ion-card-content>
    </ion-card>
  </ion-content>

  <h1>Choisissez votre nouveau mot de passe</h1>

  <form id='form'>
    <input type='text' placeholder='Votre nouveau mot de passe' id='newPwd'></input>
    <button type='submit'>Valider</button>

  </form>
  <div id='message'></div>

  <script>

      const form= document.getElementById('form');
      const newPwd = document.getElementById('newPwd');
      let user;

      const queryString = window.location.search;
      console.log(queryString);

      const urlParams = new URLSearchParams(queryString);

      const id = urlParams.get('id')
      console.log(id);


      const token = urlParams.get('token')
      console.log(token);

      const URL = 'https://guarded-fortress-84785.herokuapp.com'


      // verify token
      // on essaye de récupérer le user
      const verifyToken = async (id, token)=>{
        const options = {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json;charset=UTF-8'
          },
          body: JSON.stringify({
            id: id,
            token: token
          })
        };
        const response = await fetch(`${URL}/api/v1/letters/reset-password`, options)
        console.log(response);
        const responseJS = await response.json()
        console.log(responseJS)
        if (responseJS.success){
          user = responseJS.user;
          console.log(user, 'user ?')
        }else{
          console.log('erreur')
        }
      }

      verifyToken(id, token)

      // maintenant on peut faire la suite :
      // take new value et faire un appel pour enregistrer le nouveau mot de passe.

      form.addEventListener('submit', async (e)=>{
        message.innerText='';
        e.preventDefault();
        const val = newPwd.value.trim();
        console.log(val, 'val');

        if(val.length <=6){
          console.log('erreur')
          message.innerText = 'Le mot de passe doit contenir 7 caractères minimum'
        }else{
          // appel vers api

          // création d'un nouvel objet
          // const obj = {
          //   user: 'user',
          //   newPwd: val,
          // };
          console.log(user?.id, 'id user')
          // appel au service update-user
          const options = {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json;charset=UTF-8'
            },
            body: JSON.stringify({
              _id: user?.id,
              newPwd: val,
            })
          };
          const responseJSON = await fetch('https://guarded-fortress-84785.herokuapp.com/api/v1/letters/save-new-password',
          options);
          const responseJS = await responseJSON.json();
          console.log(responseJS)

          // gestion des messages utilisateurs
          if(responseJS.success){
            message.innerText = 'Mot de passe modifié avec succès. Vous pouvez refermer cette page.'
          }else{
            message.innerText = responseJS.msg

          }


        }

      })



  </script>
</body>
</html>
